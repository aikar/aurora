/*** Generated by streamline 0.1.44 - DO NOT EDIT ***/ "use strict"; var __g=typeof global!=='undefined'?global:window;__g=(__g.__streamline||(__g.__streamline={}));__g.setEF=__g.setEF||function(e,f){e.__frame = e.__frame||f};var __srcName='streamline/lib/compiler/compile_.js'; function __func(_, __this, __arguments, fn, index, frame, body){ if (!_) { return __future.call(__this, fn, __arguments, index); } frame.file = __srcName; frame.prev = __g.frame; __g.frame = frame; try { body(); } catch (e) { __g.setEF(e, frame.prev); __propagate(_, e); } finally { __g.frame = frame.prev; } } function __cb(_, frame, offset, col, fn){ frame.offset = offset; frame.col = col; var ctx = __g.context; return function ___(err, result){ var oldFrame = __g.frame; __g.frame = frame; __g.context = ctx; try { if (err) { __g.setEF(err, frame); return _(err); } return fn(null, result); } catch (ex) { __g.setEF(ex, frame); return __propagate(_, ex); } finally { __g.frame = oldFrame; } } } function __future(fn, args, i){ var done, err, result; var cb = function(e, r){ done = true; err = e, result = r; }; args = Array.prototype.slice.call(args); args[i] = function ___(e, r){ cb(e, r); }; fn.apply(this, args); return function ___(_){ if (done) _.call(this, err, result); else cb = _.bind(this); } .bind(this); } function __propagate(_, err){ try { _(err); } catch (ex) { __trap(ex); } } function __trap(err){ if (err) { if (__g.context && __g.context.errorHandler) __g.context.errorHandler(err); else console.error("UNCAUGHT EXCEPTION: " + err.message + "\n" + err.stack); } } function __tryCatch(_, fn){ try { fn(); } catch (e) { try { _(e); } catch (ex) { __trap(ex); } } } var fs = require("fs");









var fspath = require("path");
var transform = require("./transform");

function _exists(callback, fname) {
 fspath.exists(fname, function(result) {
 callback(null, result); });};



function _mkdir(dir, mode, _) { var p; var __frame = { name: "_mkdir", line: 20 }; return __func(_, this, arguments, _mkdir, 2, __frame, function __$_mkdir() {
 p = fspath.dirname(dir);
 return _exists(p, __cb(_, __frame, 2, 6, function ___(__0, __2) { var __1 = !__2; return (function __$_mkdir(__then) { if (__1) {
 return _mkdir(p, mode, __cb(_, __frame, 3, 2, __then)); } else { __then(); } ; })(function __$_mkdir() {
 return fs.mkdir(dir, mode, __cb(_, __frame, 4, 1, _)); }); })); });};


function mtime(_, fname) { var __frame = { name: "mtime", line: 27 }; return __func(_, this, arguments, mtime, 0, __frame, function __$mtime() { return (function __$mtime(_) {
 return _exists(__cb(_, __frame, 1, 8, function ___(__0, __1) { var __2 = __1; return (function __$mtime(__then) { if (__2) { return fs.stat(fname, __cb(_, __frame, 1, 28, function ___(__0, __4) { var __3 = __4.mtime; return _(null, __3); })); } else { __then(); } ; })(function __$mtime() { return _(null, 0); }); }), fname); })(__cb(_, __frame, -26, 22, _)); });};














exports.loadFile = function exports_loadFile__1(_, path, options) { var dontSave, js, js_, mtimejs, mtimejs_, banner, content, transformed; var __frame = { name: "exports_loadFile__1", line: 43 }; return __func(_, this, arguments, exports_loadFile__1, 0, __frame, function __$exports_loadFile__1() {
 if ((path.substring((path.length - 3)) === ".js")) {
 path = path.substring(0, (path.length - 3)); } ;
 options = (options || { });
 options.sourceName = path;
 dontSave = (path[(path.length - 1)] == "_");
 if (dontSave) {
 path = path.substring(0, (path.length - 1));
 options.lines = (options.lines || "preserve"); }

 else {
 options.lines = (options.lines || "mark"); } ;

 js = (path + ".js");
 js_ = (path + "_.js");

 return mtime(__cb(_, __frame, 16, 15, function ___(__0, __2) { mtimejs = __2;
 return mtime(__cb(_, __frame, 17, 16, function ___(__0, __3) { mtimejs_ = __3;

 banner = transform.banner(); return (function __$exports_loadFile__1(__then) {

 if (mtimejs_) {
 return fs.readFile(js_, "utf8", __cb(_, __frame, 22, 16, function ___(__0, __4) { content = __4; return (function __$exports_loadFile__1(_) {
 var __1 = mtimejs; if (!__1) { return _(null, __1); } ; return fs.readFile(js, "utf8", __cb(_, __frame, 23, 31, _)); })(__cb(_, __frame, -42, 22, function ___(__0, __5) { transformed = __5;
 if ((((transformed && (mtimejs_ < mtimejs)) && (transformed.substring(0, banner.length) == banner)) && !options.force)) {



 return _(null, transformed); } ;
 if (options.verbose) {
 console.log(("streamline: transforming: " + js_)); } ;
 transformed = (banner + transform.transform(content, options)); return (function __$exports_loadFile__1(__then) {
 if (!dontSave) { return (function ___(__then) { (function ___(_) { __tryCatch(_, function __$exports_loadFile__1() {


 return fs.writeFile(js, transformed, "utf8", __cb(_, __frame, 35, 4, __then)); }); })(function ___(ex, __result) { __tryCatch(_, function __$exports_loadFile__1() { if (ex) { __then(); } else { _(null, __result); } ; }); }); })(function ___() { __tryCatch(_, __then); }); } else { __then(); } ; })(function __$exports_loadFile__1() {




 return _(null, transformed); }); })); })); } else {


 return fs.readFile(js, "utf8", __cb(_, __frame, 43, 9, _)); } ; })(_); }), js_); }), js); });};



function mtimeSync(fname) {
 try {
 return fs.statSync(fname).mtime;

 } catch (ex) {
 return 0; };};






exports.loadFileSync = function(path, options) {
 if ((path.substring((path.length - 3)) === ".js")) {
 path = path.substring(0, (path.length - 3)); };
 options = (options || { });
 options.sourceName = path;
 var dontSave = (path[(path.length - 1)] == "_");
 if (dontSave) {
 path = path.substring(0, (path.length - 1));
 options.lines = (options.lines || "preserve"); }

 else {
 options.lines = (options.lines || "mark"); };

 var js = (path + ".js");
 var js_ = (path + "_.js");

 var mtimejs = mtimeSync(js);
 var mtimejs_ = mtimeSync(js_);

 var banner = transform.banner();

 if (mtimejs_) {
 var content = fs.readFileSync(js_, "utf8");
 var transformed = (mtimejs && fs.readFileSync(js, "utf8"));
 if ((((transformed && (mtimejs_ < mtimejs)) && (transformed.substring(0, banner.length) == banner)) && !options.force)) {



 return transformed };
 if (options.verbose) {
 console.log(("streamline: transforming: " + js_)); };
 var transformed = (banner + transform.transform(content, options));
 if (!dontSave) {

 try {
 fs.writeFileSync(js, transformed, "utf8");

 } catch (ex) {  }; } ;


 return transformed; }

 else {
 return fs.readFileSync(js, "utf8"); };};









exports.compile = function exports_compile__2(_, paths, options) { var flows, failed, cwd;


 function _compile(_, path, options) { var stat, js; var __frame = { name: "_compile", line: 158 }; return __func(_, this, arguments, _compile, 0, __frame, function __$_compile() {
 return fs.stat(path, __cb(_, __frame, 1, 13, function ___(__0, __2) { stat = __2; return (function __$_compile(__then) {
 if (stat.isDirectory()) {
 return fs.readdir(path, __cb(_, __frame, 3, 17, function ___(__0, __3) { return flows.each(__cb(_, __frame, 3, 3, __then), __3, function __1(_, f) { var __frame = { name: "__1", line: 161 }; return __func(_, this, arguments, __1, 0, __frame, function __$__1() {
 return _compile(__cb(_, __frame, 1, 4, _), ((path + "/") + f), options); }); }); })); } else { return (function __$_compile(__then) {

 if ((stat.isFile() && path.match(/_\.js$/))) { return (function ___(__then) { (function ___(_) { __tryCatch(_, function __$_compile() {

 js = (path.substring(0, (path.length - 4)) + ".js");
 return exports.loadFile(__cb(_, __frame, 9, 4, __then), js, options); }); })(function ___(ex, __result) { __tryCatch(_, function __$_compile() { if (ex) {

 console.error(ex.message);
 failed++; __then(); } else { _(null, __result); } ; }); }); })(function ___() { __tryCatch(_, __then); }); } else { __then(); } ; })(__then); } ; })(_); })); }); }; var __frame = { name: "exports_compile__2", line: 155 }; return __func(_, this, arguments, exports_compile__2, 0, __frame, function __$exports_compile__2() { flows = require("../util/flows");





 failed = 0;
 options = (options || { });
 if (options.verbose) {
 console.log(("transform version: " + transform.version)); } ;
 if ((!paths || (paths.length == 0))) {
 return _(new Error("cannot compile: no files specified")); } ;
 cwd = process.cwd;
 return flows.each(__cb(_, __frame, 28, 1, function __$exports_compile__2() {


 if (failed) {
 return _(new Error((("errors found in " + failed) + " files"))); } ; _(); }), paths, function __1(_, path) { var __frame = { name: "__1", line: 183 }; return __func(_, this, arguments, __1, 0, __frame, function __$__1() { return _compile(__cb(_, __frame, 1, 2, _), fspath.join(cwd, path), options); }); }); });};